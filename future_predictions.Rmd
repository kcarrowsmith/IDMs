---
title: "IDM Future Climates"
author: "Kaysee Arrowsmith"
output: html_document
---

# Load Packages

```{r packages, message = F}
options(java.parameters = "- Xmx1024m")
library(knitr)
library(tidyverse)
library(raster)
library(geodata)
library(ENMTools)
library(predicts)
library(rJava)
library(glmmTMB)
library(DHARMa)
library(performance)
library(car)

theme_set(theme_light() +
            theme(text = element_text(size = 20)))
```

# Load Data

```{r data}
bbna <- read.csv("bbna_pnwbba.csv", stringsAsFactors = F)
gbif <- read_tsv("gbif-top5.csv") %>%
  filter(year >= 2018)
all.evals <- read.csv("all-evals.csv")

bbna.sum <- bbna %>%
  group_by(species) %>%
  tally(name = "n_bombus")

gbif.sum <- gbif %>%
  group_by(genus) %>%
  tally(name = "n_plant")

int.sum <- bbna %>%
  group_by(species, plant.host.genus) %>%
  tally(name = "n_int") %>%
  left_join(bbna.sum, by = "species") %>%
  mutate(relabund_int = n_int/n_bombus)

all.evals <- read.csv("all-evals.csv")
mean.evals <- all.evals %>%
  group_by(X, model) %>%
  summarise(tstar = mean(tstar))
```

# WorldClim Data

I'm cropping all of these predictor rasters to the extreme points of my GBIF data.

```{r worldclim, message = F}
bioclim <- crop(worldclim_global(var = "bio", 
                               res = 2.5, 
                               path = getwd()),
                ext(-130, -110, 40, 50))
```

```{r cmip}
cmip.df <- data.frame(time = c(rep("2021-2040", 50), 
                               rep("2061-2080", 50)),
                      ssp = c(rep("245", 25), 
                              rep("585", 25), 
                              rep("245", 25), 
                              rep("585", 25)),
                      model = rep(c("ACCESS-CM2", 
                                    "ACCESS-ESM1-5", 
                                    "AWI-CM-1-1-MR", 
                                    "BCC-CSM2-MR", 
                                    "CanESM5", 
                                    "CanESM5-CanOE", 
                                    "CMCC-ESM2", 
                                    "CNRM-CM6-1", 
                                    "CNRM-CM6-1-HR", 
                                    "CNRM-ESM2-1", 
                                    "EC-Earth3-Veg", 
                                    "EC-Earth3-Veg-LR", 
                                    "FIO-ESM-2-0", 
                                    "GISS-E2-1-G", 
                                    "GISS-E2-1-H", 
                                    "HadGEM3-GC31-LL", 
                                    "INM-CM4-8", 
                                    "INM-CM5-0", 
                                    "IPSL-CM6A-LR", 
                                    "MIROC-ES2L", 
                                    "MIROC6", 
                                    "MPI-ESM1-2-HR", 
                                    "MPI-ESM1-2-LR", 
                                    "MRI-ESM2-0", 
                                    "UKESM1-0-LL"), 4))

intpair.df <- data.frame(pair = c(rep("bifcham", 2), rep("bifcir", 2), rep("biflup", 2), rep("bifpen", 2), rep("bifrub", 2),
                                  rep("flavcham", 2), rep("flavcir", 2), rep("flavlup", 2), rep("flavpen", 2), rep("flavrub", 2),
                                  rep("mixcham", 2), rep("mixcir", 2), rep("mixlup", 2), rep("mixpen", 2), rep("mixrub", 2),
                                  rep("voscham", 2), rep("voscir", 2), rep("voslup", 2), rep("vospen", 2), rep("vosrub", 2)),
                         plant = c(rep(c(rep("Chamaenerion", 2), rep("Cirsium", 2), rep("Lupinus", 2), rep("Penstemon", 2), rep("Rubus", 2)), 4)),
                         bombus = c(rep("bifarius", 10),
                                    rep("flavifrons", 10),
                                    rep("mixtus", 10),
                                    rep("vosnesenskii", 10)),
                         model = rep(c("overlap", "IDM"), 20)) %>%
  left_join(mean.evals, by = c(c("pair" = "X"), "model"))
```


# Re-Build Models
Instead of bootstrapping with different subsets of data, I'm just using the entire dataset as training data. This only makes sense since I'm not doing any validation now.

## B. bifarius
### Chamaenerion
```{r bifcham models}
gbif.cham <- gbif %>%
  filter(genus == "Chamaenerion")

bifcham <- bbna %>%
  filter(species == "bifarius",
         plant.host.genus == "Chamaenerion") %>%
  dplyr::select(latitude, longitude, plant.host.genus, date, month, day, year)

bg <- as.data.frame(spatSample(x = bioclim, size = 10000, method = "random", na.rm = T, xy = T)) %>%
    dplyr::select(x, y) %>%
    rename(longitude = x,
           latitude = y)
  
  bif.longlat <- bbna %>%
    filter(species == "bifarius",
           plant.host.genus != "Chamaenerion") %>%
    slice_sample(by = BBNA.code, n = 1) %>%
    dplyr::select(longitude, latitude) %>%
  as.data.frame(.)
  
  cham.longlat <- gbif.cham %>%
  dplyr::select(decimalLongitude, decimalLatitude) %>%
  as.data.frame(.) %>%
  rename(longitude = decimalLongitude,
         latitude = decimalLatitude)
  
  bifcham.longlat <- bifcham %>%
  dplyr::select(longitude, latitude) %>%
  as.data.frame(.)
  
  cham.maxent <- maxent(x = stack(bioclim), 
                       p = cham.longlat, 
                       a = bg)
  
  bif.maxent <- maxent(x = stack(bioclim), 
                       p = bif.longlat, 
                       a = bg)
  
  bifcham.maxent <- maxent(x = stack(bioclim), 
                          p = bifcham.longlat, 
                          a = bg)
```


### Cirsium
```{r bifcir models}
gbif.cir <- gbif %>%
  filter(genus == "Cirsium")

bifcir <- bbna %>%
  filter(species == "bifarius",
         plant.host.genus == "Cirsium") %>%
  dplyr::select(latitude, longitude, plant.host.genus, date, month, day, year)

bif.longlat <- bbna %>%
    filter(species == "bifarius",
           plant.host.genus != "Cirsium") %>%
    slice_sample(by = BBNA.code, n = 1) %>%
    dplyr::select(longitude, latitude) %>%
  as.data.frame(.)
  
  cir.longlat <- gbif.cir %>%
  dplyr::select(decimalLongitude, decimalLatitude) %>%
  as.data.frame(.) %>%
  rename(longitude = decimalLongitude,
         latitude = decimalLatitude)
  
  bifcir.longlat <- bifcir %>%
  dplyr::select(longitude, latitude) %>%
  as.data.frame(.)
  
  bif.maxent <- maxent(x = stack(bioclim), 
                       p = bif.longlat, 
                       a = bg)
  
    cir.maxent <- maxent(x = stack(bioclim), 
                       p = cir.longlat, 
                       a = bg)
  
  bifcir.maxent <- maxent(x = stack(bioclim), 
                          p = bifcir.longlat, 
                          a = bg)
```

### Lupinus
```{r biflup models}
gbif.lup <- gbif %>%
  filter(genus == "Lupinus")

biflup <- bbna %>%
  filter(species == "bifarius",
         plant.host.genus == "Lupinus") %>%
  dplyr::select(latitude, longitude, plant.host.genus, date, month, day, year)

bif.longlat <- bbna %>%
    filter(species == "bifarius",
           plant.host.genus != "Lupinus") %>%
    slice_sample(by = BBNA.code, n = 1) %>%
    dplyr::select(longitude, latitude) %>%
  as.data.frame(.)
  
  lup.longlat <- gbif.lup %>%
  dplyr::select(decimalLongitude, decimalLatitude) %>%
  as.data.frame(.) %>%
  rename(longitude = decimalLongitude,
         latitude = decimalLatitude)
  
  biflup.longlat <- biflup %>%
  dplyr::select(longitude, latitude) %>%
  as.data.frame(.)
  
  lup.maxent <- maxent(x = stack(bioclim), 
                       p = lup.longlat, 
                       a = bg)
  
  bif.maxent <- maxent(x = stack(bioclim), 
                       p = bif.longlat, 
                       a = bg)
  
  biflup.maxent <- maxent(x = stack(bioclim), 
                          p = biflup.longlat, 
                          a = bg)
```

### Penstemon
```{r bifpen models}
gbif.pen <- gbif %>%
  filter(genus == "Penstemon")

bifpen <- bbna %>%
  filter(species == "bifarius",
         plant.host.genus == "Penstemon") %>%
  dplyr::select(latitude, longitude, plant.host.genus, date, month, day, year)

bif.longlat <- bbna %>%
    filter(species == "bifarius",
           plant.host.genus != "Penstemon") %>%
    slice_sample(by = BBNA.code, n = 1) %>%
    dplyr::select(longitude, latitude) %>%
  as.data.frame(.)
  
  pen.longlat <- gbif.pen %>%
  dplyr::select(decimalLongitude, decimalLatitude) %>%
  as.data.frame(.) %>%
  rename(longitude = decimalLongitude,
         latitude = decimalLatitude)
  
  bifpen.longlat <- bifpen %>%
  dplyr::select(longitude, latitude) %>%
  as.data.frame(.)
  
  pen.maxent <- maxent(x = stack(bioclim), 
                       p = pen.longlat, 
                       a = bg)

    bif.maxent <- maxent(x = stack(bioclim), 
                       p = bif.longlat, 
                       a = bg)
  
  bifpen.maxent <- maxent(x = stack(bioclim), 
                          p = bifpen.longlat, 
                          a = bg)
```

### Rubus
```{r bifrub models}
gbif.rub <- gbif %>%
  filter(genus == "Rubus")

bifrub <- bbna %>%
  filter(species == "bifarius",
         plant.host.genus == "Rubus") %>%
  dplyr::select(latitude, longitude, plant.host.genus, date, month, day, year)

bif.longlat <- bbna %>%
    filter(species == "bifarius",
           plant.host.genus != "Rubus") %>%
    slice_sample(by = BBNA.code, n = 1) %>%
    dplyr::select(longitude, latitude) %>%
  as.data.frame(.)
  
  rub.longlat <- gbif.rub %>%
  dplyr::select(decimalLongitude, decimalLatitude) %>%
  as.data.frame(.) %>%
  rename(longitude = decimalLongitude,
         latitude = decimalLatitude)
  
  bifrub.longlat <- bifrub %>%
  dplyr::select(longitude, latitude) %>%
  as.data.frame(.)
  
  rub.maxent <- maxent(x = stack(bioclim), 
                       p = rub.longlat, 
                       a = bg)

    bif.maxent <- maxent(x = stack(bioclim), 
                       p = bif.longlat, 
                       a = bg)
  
  bifrub.maxent <- maxent(x = stack(bioclim), 
                          p = bifrub.longlat, 
                          a = bg)
```

I don't need to re-create any of the flower ones now, though I do need to re-create the bee ones for each pair.

## B. flavifrons
### Chamaenerion
```{r flavcham models}
flavcham <- bbna %>%
  filter(species == "flavifrons",
         plant.host.genus == "Chamaenerion") %>%
  dplyr::select(latitude, longitude, plant.host.genus, date, month, day, year)

flav.longlat <- bbna %>%
    filter(species == "flavifrons",
           plant.host.genus != "Chamaenerion") %>%
    slice_sample(by = BBNA.code, n = 1) %>%
    dplyr::select(longitude, latitude) %>%
  as.data.frame(.)
  
  flavcham.longlat <- flavcham %>%
  dplyr::select(longitude, latitude) %>%
  as.data.frame(.)

    flav.maxent <- maxent(x = stack(bioclim), 
                       p = flav.longlat, 
                       a = bg)
  
  flavcham.maxent <- maxent(x = stack(bioclim), 
                          p = flavcham.longlat, 
                          a = bg)
```


### Cirsium
```{r flavcir models}
flavcir <- bbna %>%
  filter(species == "flavifrons",
         plant.host.genus == "Cirsium") %>%
  dplyr::select(latitude, longitude, plant.host.genus, date, month, day, year)
  
  flav.longlat <- bbna %>%
    filter(species == "flavifrons",
           plant.host.genus != "Cirsium") %>%
    slice_sample(by = BBNA.code, n = 1) %>%
    dplyr::select(longitude, latitude) %>%
  as.data.frame(.)
  
  flavcir.longlat <- flavcir %>%
  dplyr::select(longitude, latitude) %>%
  as.data.frame(.)
  
  flav.maxent <- maxent(x = stack(bioclim), 
                       p = flav.longlat, 
                       a = bg)
  
  flavcir.maxent <- maxent(x = stack(bioclim), 
                          p = flavcir.longlat, 
                          a = bg)
```

### Lupinus
```{r flavlup models}
flavlup <- bbna %>%
  filter(species == "flavifrons",
         plant.host.genus == "Lupinus") %>%
  dplyr::select(latitude, longitude, plant.host.genus, date, month, day, year)
  
  flav.longlat <- bbna %>%
    filter(species == "flavifrons",
           plant.host.genus != "Lupinus") %>%
    slice_sample(by = BBNA.code, n = 1) %>%
    dplyr::select(longitude, latitude) %>%
  as.data.frame(.)
  
  flavlup.longlat <- flavlup %>%
  dplyr::select(longitude, latitude) %>%
  as.data.frame(.)

  flav.maxent <- maxent(x = stack(bioclim), 
                       p = flav.longlat, 
                       a = bg)
  
  flavlup.maxent <- maxent(x = stack(bioclim), 
                          p = flavlup.longlat, 
                          a = bg)
```

### Penstemon
```{r flavpen models}
flavpen <- bbna %>%
  filter(species == "flavifrons",
         plant.host.genus == "Penstemon") %>%
  dplyr::select(latitude, longitude, plant.host.genus, date, month, day, year)
  
  flav.longlat <- bbna %>%
    filter(species == "flavifrons",
           plant.host.genus != "Penstemon") %>%
    slice_sample(by = BBNA.code, n = 1) %>%
    dplyr::select(longitude, latitude) %>%
  as.data.frame(.)

  flavpen.longlat <- flavpen %>%
  dplyr::select(longitude, latitude) %>%
  as.data.frame(.)
  
flav.maxent <- maxent(x = stack(bioclim), 
                       p = flav.longlat, 
                       a = bg)
  
  flavpen.maxent <- maxent(x = stack(bioclim), 
                          p = flavpen.longlat, 
                          a = bg)
```

### Rubus
```{r flavrub models}
flavrub <- bbna %>%
  filter(species == "flavifrons",
         plant.host.genus == "Rubus") %>%
  dplyr::select(latitude, longitude, plant.host.genus, date, month, day, year)
  
  flav.longlat <- bbna %>%
    filter(species == "flavifrons",
           plant.host.genus != "Rubus") %>%
    slice_sample(by = BBNA.code, n = 1) %>%
    dplyr::select(longitude, latitude) %>%
  as.data.frame(.)
  
  flavrub.longlat <- flavrub %>%
  dplyr::select(longitude, latitude) %>%
  as.data.frame(.)
  
  flav.maxent <- maxent(x = stack(bioclim), 
                       p = flav.longlat, 
                       a = bg)
  
  flavrub.maxent <- maxent(x = stack(bioclim), 
                          p = flavrub.longlat, 
                          a = bg)
```

## B. mixtus
### Chamaenerion
```{r mixcham models}
mixcham <- bbna %>%
  filter(species == "mixtus",
         plant.host.genus == "Chamaenerion") %>%
  dplyr::select(latitude, longitude, plant.host.genus, date, month, day, year)

mix.longlat <- bbna %>%
    filter(species == "mixtus",
           plant.host.genus != "Chamaenerion") %>%
    slice_sample(by = BBNA.code, n = 1) %>%
    dplyr::select(longitude, latitude) %>%
  as.data.frame(.)
  
mixcham.longlat <- mixcham %>%
  dplyr::select(longitude, latitude) %>%
  as.data.frame(.)
  
  mix.maxent <- maxent(x = stack(bioclim), 
                       p = mix.longlat, 
                       a = bg)
  
  mixcham.maxent <- maxent(x = stack(bioclim), 
                          p = mixcham.longlat, 
                          a = bg)
```

### Cirsium
```{r mixcir models}
mixcir <- bbna %>%
  filter(species == "mixtus",
         plant.host.genus == "Cirsium") %>%
  dplyr::select(latitude, longitude, plant.host.genus, date, month, day, year)

mix.longlat <- bbna %>%
    filter(species == "mixtus",
           plant.host.genus != "Cirsium") %>%
    slice_sample(by = BBNA.code, n = 1) %>%
    dplyr::select(longitude, latitude) %>%
  as.data.frame(.)
  
mixcir.longlat <- mixcir %>%
  dplyr::select(longitude, latitude) %>%
  as.data.frame(.)
  
  mix.maxent <- maxent(x = stack(bioclim), 
                       p = mix.longlat, 
                       a = bg)
  
  mixcir.maxent <- maxent(x = stack(bioclim), 
                          p = mixcir.longlat, 
                          a = bg)
```

### Lupinus
```{r mixlup models}
mixlup <- bbna %>%
  filter(species == "mixtus",
         plant.host.genus == "Lupinus") %>%
  dplyr::select(latitude, longitude, plant.host.genus, date, month, day, year)

mix.longlat <- bbna %>%
    filter(species == "mixtus",
           plant.host.genus != "Lupinus") %>%
    slice_sample(by = BBNA.code, n = 1) %>%
    dplyr::select(longitude, latitude) %>%
  as.data.frame(.)
  
 mixlup.longlat <- mixlup %>%
  dplyr::select(longitude, latitude) %>%
  as.data.frame(.)
  
  mix.maxent <- maxent(x = stack(bioclim), 
                       p = mix.longlat, 
                       a = bg)
  
  mixlup.maxent <- maxent(x = stack(bioclim), 
                          p = mixlup.longlat, 
                          a = bg)
```

### Penstemon
```{r mixpen models}
mixpen <- bbna %>%
  filter(species == "mixtus",
         plant.host.genus == "Penstemon") %>%
  dplyr::select(latitude, longitude, plant.host.genus, date, month, day, year)

mix.longlat <- bbna %>%
    filter(species == "mixtus",
           plant.host.genus != "Penstemon") %>%
    slice_sample(by = BBNA.code, n = 1) %>%
    dplyr::select(longitude, latitude) %>%
  as.data.frame(.)
  
 mixpen.longlat <- mixpen %>%
  dplyr::select(longitude, latitude) %>%
  as.data.frame(.)
  
  mix.maxent <- maxent(x = stack(bioclim), 
                       p = mix.longlat, 
                       a = bg)
  
  mixpen.maxent <- maxent(x = stack(bioclim), 
                          p = mixpen.longlat, 
                          a = bg)
```

### Rubus
```{r mixrub models}
mixrub <- bbna %>%
  filter(species == "mixtus",
         plant.host.genus == "Rubus") %>%
  dplyr::select(latitude, longitude, plant.host.genus, date, month, day, year)

mix.longlat <- bbna %>%
    filter(species == "mixtus",
           plant.host.genus != "Rubus") %>%
    slice_sample(by = BBNA.code, n = 1) %>%
    dplyr::select(longitude, latitude) %>%
  as.data.frame(.)
  
  mixrub.longlat <- mixrub %>%
  dplyr::select(longitude, latitude) %>%
  as.data.frame(.)
  
  mix.maxent <- maxent(x = stack(bioclim), 
                       p = mix.longlat, 
                       a = bg)
  
  mixrub.maxent <- maxent(x = stack(bioclim), 
                          p = mixrub.longlat, 
                          a = bg)
```

## B. vosnesenskii
### Chamaenerion
```{r voscham models}
voscham <- bbna %>%
  filter(species == "vosnesenskii",
         plant.host.genus == "Chamaenerion") %>%
  dplyr::select(latitude, longitude, plant.host.genus, date, month, day, year)

vos.longlat <- bbna %>%
    filter(species == "vosnesenskii",
           plant.host.genus != "Chamaenerion") %>%
    slice_sample(by = BBNA.code, n = 1) %>%
    dplyr::select(longitude, latitude) %>%
  as.data.frame(.)
  
voscham.longlat <- voscham %>%
  dplyr::select(longitude, latitude) %>%
  as.data.frame(.)
  
  vos.maxent <- maxent(x = stack(bioclim), 
                       p = vos.longlat, 
                       a = bg)

  voscham.maxent <- maxent(x = stack(bioclim), 
                          p = voscham.longlat, 
                          a = bg)
```


### Cirsium
```{r voscir models}
voscir <- bbna %>%
  filter(species == "vosnesenskii",
         plant.host.genus == "Cirsium") %>%
  dplyr::select(latitude, longitude, plant.host.genus, date, month, day, year)

vos.longlat <- bbna %>%
    filter(species == "vosnesenskii",
           plant.host.genus != "Cirsium") %>%
    slice_sample(by = BBNA.code, n = 1) %>%
    dplyr::select(longitude, latitude) %>%
  as.data.frame(.)
  
voscir.longlat <- voscir %>%
  dplyr::select(longitude, latitude) %>%
  as.data.frame(.)
  
  vos.maxent <- maxent(x = stack(bioclim), 
                       p = vos.longlat, 
                       a = bg)

  voscir.maxent <- maxent(x = stack(bioclim), 
                          p = voscir.longlat, 
                          a = bg)
```

### Lupinus
```{r voslup models}
voslup <- bbna %>%
  filter(species == "vosnesenskii",
         plant.host.genus == "Lupinus") %>%
  dplyr::select(latitude, longitude, plant.host.genus, date, month, day, year)

vos.longlat <- bbna %>%
    filter(species == "vosnesenskii",
           plant.host.genus != "Lupinus") %>%
    slice_sample(by = BBNA.code, n = 1) %>%
    dplyr::select(longitude, latitude) %>%
  as.data.frame(.)
  
voslup.longlat <- voslup %>%
  dplyr::select(longitude, latitude) %>%
  as.data.frame(.)
  
  vos.maxent <- maxent(x = stack(bioclim), 
                       p = vos.longlat, 
                       a = bg)
voslup.maxent <- maxent(x = stack(bioclim), 
                          p = voslup.longlat, 
                          a = bg)
```

### Penstemon
```{r vospen models}
vospen <- bbna %>%
  filter(species == "vosnesenskii",
         plant.host.genus == "Penstemon") %>%
  dplyr::select(latitude, longitude, plant.host.genus, date, month, day, year)

vos.longlat <- bbna %>%
    filter(species == "vosnesenskii",
           plant.host.genus != "Penstemon") %>%
    slice_sample(by = BBNA.code, n = 1) %>%
    dplyr::select(longitude, latitude) %>%
  as.data.frame(.)
  
vospen.longlat <- vospen %>%
  dplyr::select(longitude, latitude) %>%
  as.data.frame(.)
  
  vos.maxent <- maxent(x = stack(bioclim), 
                       p = vos.longlat, 
                       a = bg)

  vospen.maxent <- maxent(x = stack(bioclim), 
                          p = vospen.longlat, 
                          a = bg)
```

### Rubus
```{r vosrub models}
vosrub <- bbna %>%
  filter(species == "vosnesenskii",
         plant.host.genus == "Rubus") %>%
  dplyr::select(latitude, longitude, plant.host.genus, date, month, day, year)

vos.longlat <- bbna %>%
    filter(species == "vosnesenskii",
           plant.host.genus != "Rubus") %>%
    slice_sample(by = BBNA.code, n = 1) %>%
    dplyr::select(longitude, latitude) %>%
  as.data.frame(.)
  
vosrub.longlat <- vosrub %>%
  dplyr::select(longitude, latitude) %>%
  as.data.frame(.)
  
  vos.maxent <- maxent(x = stack(bioclim), 
                       p = vos.longlat, 
                       a = bg)

  vosrub.maxent <- maxent(x = stack(bioclim), 
                          p = vosrub.longlat, 
                          a = bg)
```

# Projections
This is a for-loop that projects everything.
```{r predict}
bifcham.idm.predict <- vector(mode = "list", length = nrow(cmip.df))
bifcham.overlap.predict <- vector(mode = "list", length = nrow(cmip.df))
bifcir.idm.predict <- vector(mode = "list", length = nrow(cmip.df))
bifcir.overlap.predict <- vector(mode = "list", length = nrow(cmip.df))
biflup.idm.predict <- vector(mode = "list", length = nrow(cmip.df))
biflup.overlap.predict <- vector(mode = "list", length = nrow(cmip.df))
bifpen.idm.predict <- vector(mode = "list", length = nrow(cmip.df))
bifpen.overlap.predict <- vector(mode = "list", length = nrow(cmip.df))
bifrub.idm.predict <- vector(mode = "list", length = nrow(cmip.df))
bifrub.overlap.predict <- vector(mode = "list", length = nrow(cmip.df))

flavcham.idm.predict <- vector(mode = "list", length = nrow(cmip.df))
flavcham.overlap.predict <- vector(mode = "list", length = nrow(cmip.df))
flavcir.idm.predict <- vector(mode = "list", length = nrow(cmip.df))
flavcir.overlap.predict <- vector(mode = "list", length = nrow(cmip.df))
flavlup.idm.predict <- vector(mode = "list", length = nrow(cmip.df))
flavlup.overlap.predict <- vector(mode = "list", length = nrow(cmip.df))
flavpen.idm.predict <- vector(mode = "list", length = nrow(cmip.df))
flavpen.overlap.predict <- vector(mode = "list", length = nrow(cmip.df))
flavrub.idm.predict <- vector(mode = "list", length = nrow(cmip.df))
flavrub.overlap.predict <- vector(mode = "list", length = nrow(cmip.df))

mixcham.idm.predict <- vector(mode = "list", length = nrow(cmip.df))
mixcham.overlap.predict <- vector(mode = "list", length = nrow(cmip.df))
mixcir.idm.predict <- vector(mode = "list", length = nrow(cmip.df))
mixcir.overlap.predict <- vector(mode = "list", length = nrow(cmip.df))
mixlup.idm.predict <- vector(mode = "list", length = nrow(cmip.df))
mixlup.overlap.predict <- vector(mode = "list", length = nrow(cmip.df))
mixpen.idm.predict <- vector(mode = "list", length = nrow(cmip.df))
mixpen.overlap.predict <- vector(mode = "list", length = nrow(cmip.df))
mixrub.idm.predict <- vector(mode = "list", length = nrow(cmip.df))
mixrub.overlap.predict <- vector(mode = "list", length = nrow(cmip.df))

voscham.idm.predict <- vector(mode = "list", length = nrow(cmip.df))
voscham.overlap.predict <- vector(mode = "list", length = nrow(cmip.df))
voscir.idm.predict <- vector(mode = "list", length = nrow(cmip.df))
voscir.overlap.predict <- vector(mode = "list", length = nrow(cmip.df))
voslup.idm.predict <- vector(mode = "list", length = nrow(cmip.df))
voslup.overlap.predict <- vector(mode = "list", length = nrow(cmip.df))
vospen.idm.predict <- vector(mode = "list", length = nrow(cmip.df))
vospen.overlap.predict <- vector(mode = "list", length = nrow(cmip.df))
vosrub.idm.predict <- vector(mode = "list", length = nrow(cmip.df))
vosrub.overlap.predict <- vector(mode = "list", length = nrow(cmip.df))

for(i in 1:nrow(cmip.df)){
  cmip = crop(cmip6_world(model = cmip.df[i, 3],
                          ssp = cmip.df[i, 2],
                          time = cmip.df[i, 1],
                          var = "bioc",
                          res = "2.5",
                          path = getwd()),
              ext(-130, -110, 40, 50))
  
  names(cmip) = names(bioclim)
  
  # B. bifarius X Chamaenerion
  bifcham.overlap.predict[[i]] = dismo::predict(bif.maxent, stack(cmip)) * dismo::predict(cham.maxent, stack(cmip))
  bifcham.idm.predict[[i]] = dismo::predict(bifcham.maxent, stack(cmip))
  
  # B. bifarius X Cirsium
  bifcir.overlap.predict[[i]] = dismo::predict(bif.maxent, stack(cmip)) * dismo::predict(cir.maxent, stack(cmip))
  bifcir.idm.predict[[i]] = dismo::predict(bifcir.maxent, stack(cmip))
  
  # B. bifarius X Lupinus
  biflup.overlap.predict[[i]] = dismo::predict(bif.maxent, stack(cmip)) * dismo::predict(lup.maxent, stack(cmip))
  biflup.idm.predict[[i]] = dismo::predict(biflup.maxent, stack(cmip))
  
  # B. bifarius X Penstemon
  bifpen.overlap.predict[[i]] = dismo::predict(bif.maxent, stack(cmip)) * dismo::predict(pen.maxent, stack(cmip))
  bifpen.idm.predict[[i]] = dismo::predict(bifpen.maxent, stack(cmip))
  
    # B. bifarius X Rubus
  bifrub.overlap.predict[[i]] = dismo::predict(bif.maxent, stack(cmip)) * dismo::predict(rub.maxent, stack(cmip))
  bifrub.idm.predict[[i]] = dismo::predict(bifrub.maxent, stack(cmip))
  
  # B. flavifrons X Chamaenerion
  flavcham.overlap.predict[[i]] = dismo::predict(flav.maxent, stack(cmip)) * dismo::predict(cham.maxent, stack(cmip))
  flavcham.idm.predict[[i]] = dismo::predict(flavcham.maxent, stack(cmip))
  
  # B. flavifrons X Cirsium
  flavcir.overlap.predict[[i]] = dismo::predict(flav.maxent, stack(cmip)) * dismo::predict(cir.maxent, stack(cmip))
  flavcir.idm.predict[[i]] = dismo::predict(flavcir.maxent, stack(cmip))
  
  # B. flavifrons X Lupinus
  flavlup.overlap.predict[[i]] = dismo::predict(flav.maxent, stack(cmip)) * dismo::predict(lup.maxent, stack(cmip))
  flavlup.idm.predict[[i]] = dismo::predict(flavlup.maxent, stack(cmip))
  
  # B. flavifrons X Penstemon
  flavpen.overlap.predict[[i]] = dismo::predict(flav.maxent, stack(cmip)) * dismo::predict(pen.maxent, stack(cmip))
  flavpen.idm.predict[[i]] = dismo::predict(flavpen.maxent, stack(cmip))
  
    # B. flavifrons X Rubus
  flavrub.overlap.predict[[i]] = dismo::predict(flav.maxent, stack(cmip)) * dismo::predict(rub.maxent, stack(cmip))
  flavrub.idm.predict[[i]] = dismo::predict(flavrub.maxent, stack(cmip))
  
    # B. mixtus X Chamaenerion
  mixcham.overlap.predict[[i]] = dismo::predict(mix.maxent, stack(cmip)) * dismo::predict(cham.maxent, stack(cmip))
  mixcham.idm.predict[[i]] = dismo::predict(mixcham.maxent, stack(cmip))
  
  # B. mixtus X Cirsium
  mixcir.overlap.predict[[i]] = dismo::predict(mix.maxent, stack(cmip)) * dismo::predict(cir.maxent, stack(cmip))
  mixcir.idm.predict[[i]] = dismo::predict(mixcir.maxent, stack(cmip))
  
  # B. mixtus X Lupinus
  mixlup.overlap.predict[[i]] = dismo::predict(mix.maxent, stack(cmip)) * dismo::predict(lup.maxent, stack(cmip))
  mixlup.idm.predict[[i]] = dismo::predict(mixlup.maxent, stack(cmip))
  
  # B. mixtus X Penstemon
  mixpen.overlap.predict[[i]] = dismo::predict(mix.maxent, stack(cmip)) * dismo::predict(pen.maxent, stack(cmip))
  mixpen.idm.predict[[i]] = dismo::predict(mixpen.maxent, stack(cmip))
  
    # B. mixtus X Rubus
  mixrub.overlap.predict[[i]] = dismo::predict(mix.maxent, stack(cmip)) * dismo::predict(rub.maxent, stack(cmip))
  mixrub.idm.predict[[i]] = dismo::predict(mixrub.maxent, stack(cmip))
  
    # B. vosnesenskii X Chamaenerion
  voscham.overlap.predict[[i]] = dismo::predict(vos.maxent, stack(cmip)) * dismo::predict(cham.maxent, stack(cmip))
  voscham.idm.predict[[i]] = dismo::predict(voscham.maxent, stack(cmip))
  
  # B. vosnesenskii X Cirsium
  voscir.overlap.predict[[i]] = dismo::predict(vos.maxent, stack(cmip)) * dismo::predict(cir.maxent, stack(cmip))
  voscir.idm.predict[[i]] = dismo::predict(voscir.maxent, stack(cmip))
  
  # B. vosnesenskii X Lupinus
  voslup.overlap.predict[[i]] = dismo::predict(vos.maxent, stack(cmip)) * dismo::predict(lup.maxent, stack(cmip))
  voslup.idm.predict[[i]] = dismo::predict(voslup.maxent, stack(cmip))
  
  # B. vosnesenskii X Penstemon
  vospen.overlap.predict[[i]] = dismo::predict(vos.maxent, stack(cmip)) * dismo::predict(pen.maxent, stack(cmip))
  vospen.idm.predict[[i]] = dismo::predict(vospen.maxent, stack(cmip))
  
    # B. vosnesenskii X Rubus
  vosrub.overlap.predict[[i]] = dismo::predict(vos.maxent, stack(cmip)) * dismo::predict(rub.maxent, stack(cmip))
  vosrub.idm.predict[[i]] = dismo::predict(vosrub.maxent, stack(cmip))
}
```

## Ensemble

Now to combine all of the models into a single ensemble for each timeframe/ssp combination. Each plant-pollinator pair has two lists, one for the overlap and one for the IDM. Each of those lists is 100 spaces long and are organized as follows:

* 1--25: 2021--2040, ssp 245

* 26--50: 2021--2040, ssp 585

* 51--75: 2061--2080, ssp 245

* 76--100: 2061--2080, ssp 585

```{r ensemble}
ensemble.2040ssp245 <- vector(mode = "list", length = nrow(intpair.df))
ensemble.2080ssp245 <- vector(mode = "list", length = nrow(intpair.df))
ensemble.2040ssp585 <- vector(mode = "list", length = nrow(intpair.df))
ensemble.2080ssp585 <- vector(mode = "list", length = nrow(intpair.df))

for(i in 1:nrow(intpair.df)){
  # Create the ensemble
  temp.2040ssp245 = as(mean(stack(get(paste(intpair.df[i, 1], intpair.df[i, 4], "predict", sep = "."))[1:25])), "SpatRaster")
  temp.2040ssp585 = as(mean(stack(get(paste(intpair.df[i, 1], intpair.df[i, 4], "predict", sep = "."))[26:50])), "SpatRaster")
  temp.2080ssp245 = as(mean(stack(get(paste(intpair.df[i, 1], intpair.df[i, 4], "predict", sep = "."))[51:75])), "SpatRaster")
  temp.2080ssp585 = as(mean(stack(get(paste(intpair.df[i, 1], intpair.df[i, 4], "predict", sep = "."))[76:100])), "SpatRaster")
  
  # Normalize
  temp.2040ssp245 = (temp.2040ssp245 - minmax(temp.2040ssp245)[1,])/(minmax(temp.2040ssp245)[2,] - minmax(temp.2040ssp245)[1,])
  temp.2040ssp585 = (temp.2040ssp585 - minmax(temp.2040ssp585)[1,])/(minmax(temp.2040ssp585)[2,] - minmax(temp.2040ssp585)[1,])
  temp.2080ssp245 = (temp.2080ssp245 - minmax(temp.2080ssp245)[1,])/(minmax(temp.2080ssp245)[2,] - minmax(temp.2080ssp245)[1,])
  temp.2080ssp585 = (temp.2080ssp585 - minmax(temp.2080ssp585)[1,])/(minmax(temp.2080ssp585)[2,] - minmax(temp.2080ssp585)[1,])
  
  ensemble.2040ssp245[[i]] = temp.2040ssp245
  ensemble.2040ssp585[[i]] = temp.2040ssp585
  ensemble.2080ssp245[[i]] = temp.2080ssp245
  ensemble.2080ssp585[[i]] = temp.2080ssp585
}
```


I need to figure out how I want to compare the overlaps. Right now I'm using root mean square error (RMSE) but there are some other options. [This article](https://www.mdpi.com/2072-4292/14/21/5446) seems to have some good info on different options, though it's geared for ArcGIS, not R.

```{r RMSE}
RMSE.df <- data.frame()

for(i in 1:(nrow(intpair.df)/2)){
  RMSE.2040ssp245 = data.frame(pair = intpair.df[[2*i,1]],
                       plant = intpair.df[[2*i,2]],
                       bombus = intpair.df[[2*i,3]],
                       year = 2040,
                       ssp = 245,
                       RMSE = predicts::RMSE(na.omit(values(ensemble.2040ssp245[[(2*i)-1]])), 
                                             na.omit(values(ensemble.2040ssp245[[2*i]])), 
                                             na.rm = T))
  RMSE.2080ssp245 = data.frame(pair = intpair.df[[2*i,1]],
                       plant = intpair.df[[2*i,2]],
                       bombus = intpair.df[[2*i,3]],
                       year = 2080,
                       ssp = 245,
                       RMSE = predicts::RMSE(na.omit(values(ensemble.2080ssp245[[(2*i)-1]])), 
                                             na.omit(values(ensemble.2080ssp245[[2*i]])), 
                                             na.rm = T))
  RMSE.2040ssp585 = data.frame(pair = intpair.df[[2*i,1]],
                       plant = intpair.df[[2*i,2]],
                       bombus = intpair.df[[2*i,3]],
                       year = 2040,
                       ssp = 585,
                       RMSE = predicts::RMSE(na.omit(values(ensemble.2040ssp585[[(2*i)-1]])), 
                                             na.omit(values(ensemble.2040ssp585[[2*i]])), 
                                             na.rm = T))
  RMSE.2080ssp585 = data.frame(pair = intpair.df[[2*i,1]],
                       plant = intpair.df[[2*i,2]],
                       bombus = intpair.df[[2*i,3]],
                       year = 2080,
                       ssp = 585,
                       RMSE = predicts::RMSE(na.omit(values(ensemble.2080ssp585[[(2*i)-1]])), 
                                             na.omit(values(ensemble.2080ssp585[[2*i]])), 
                                             na.rm = T))
  
  RMSE.df = bind_rows(RMSE.df, RMSE.2040ssp245, RMSE.2080ssp245, RMSE.2040ssp585, RMSE.2080ssp585)
}
```

# Future Thresholds
```{r thresholds}
threshold.2040ssp245 <- vector(mode = "list", length = nrow(intpair.df))
threshold.2080ssp245 <- vector(mode = "list", length = nrow(intpair.df))
threshold.2040ssp585 <- vector(mode = "list", length = nrow(intpair.df))
threshold.2080ssp585 <- vector(mode = "list", length = nrow(intpair.df))
proj.areas <- bind_rows(intpair.df, intpair.df, intpair.df, intpair.df) %>%
  mutate(time = c(rep("2021-2040", 40), rep("2061-2080", 40), rep("2021-2040", 40), rep("2061-2080", 40)),
         ssp = c(rep(245, 80), rep(585, 80)),
         total_area = NA,
         overlap_area = NA,
         idm_area = NA)

for(i in 1:(nrow(intpair.df)/2)){
  # Whole thing for overlap
  thresh1 = clamp(ensemble.2040ssp245[[(2*i)-1]], lower = intpair.df[(2*i)-1, 5], upper = 1, values = T)
  thresh1[thresh1 > intpair.df[(2*i)-1, 5]] = 1
  thresh1[thresh1 <= intpair.df[(2*i)-1, 5]] = 0
  threshold.2040ssp245[[(2*i)-1]] = thresh1
  
  thresh2 = clamp(ensemble.2080ssp245[[(2*i)-1]], lower = intpair.df[(2*i)-1, 5], upper = 1, values = T)
  thresh2[thresh2 > intpair.df[(2*i)-1, 5]] = 1
  thresh2[thresh2 <= intpair.df[(2*i)-1, 5]] = 0
  threshold.2080ssp245[[(2*i)-1]] = thresh2
  
  thresh3 = clamp(ensemble.2040ssp585[[(2*i)-1]], lower = intpair.df[(2*i)-1, 5], upper = 1, values = T)
  thresh3[thresh3 > intpair.df[(2*i)-1, 5]] = 1
  thresh3[thresh3 <= intpair.df[(2*i)-1, 5]] = 0
  threshold.2040ssp585[[(2*i)-1]] = thresh3
  
  thresh4 = clamp(ensemble.2080ssp585[[(2*i)-1]], lower = intpair.df[(2*i)-1, 5], upper = 1, values = T)
  thresh4[thresh4 > intpair.df[(2*i)-1, 5]] = 1
  thresh4[thresh4 <= intpair.df[(2*i)-1, 5]] = 0
  threshold.2080ssp585[[(2*i)-1]] = thresh4
  
  proj.areas[(2*i)-1, 8] = expanse(thresh1, unit = "km")$area
  proj.areas[40 + (2*i)-1, 8] = expanse(thresh2, unit = "km")$area
  proj.areas[80 + (2*i)-1, 8] = expanse(thresh3, unit = "km")$area
  proj.areas[120 + (2*i)-1, 8] = expanse(thresh4, unit = "km")$area
  
  # Whole thing for IDM
  thresh1 = clamp(ensemble.2040ssp245[[2*i]], lower = intpair.df[2*i, 5], upper = 1, values = T)
  thresh1[thresh1 > intpair.df[2*i, 5]] = 1
  thresh1[thresh1 <= intpair.df[2*i, 5]] = 0
  threshold.2040ssp245[[2*i]] = thresh1
  
  thresh2 = clamp(ensemble.2080ssp245[[2*i]], lower = intpair.df[2*i, 5], upper = 1, values = T)
  thresh2[thresh2 > intpair.df[2*i, 5]] = 1
  thresh2[thresh2 <= intpair.df[2*i, 5]] = 0
  threshold.2080ssp245[[2*i]] = thresh2
  
  thresh3 = clamp(ensemble.2040ssp585[[2*i]], lower = intpair.df[2*i, 5], upper = 1, values = T)
  thresh3[thresh3 > intpair.df[2*i, 5]] = 1
  thresh3[thresh3 <= intpair.df[2*i, 5]] = 0
  threshold.2040ssp585[[2*i]] = thresh3
  
  thresh4 = clamp(ensemble.2080ssp585[[2*i]], lower = intpair.df[2*i, 5], upper = 1, values = T)
  thresh4[thresh4 > intpair.df[2*i, 5]] = 1
  thresh4[thresh4 <= intpair.df[2*i, 5]] = 0
  threshold.2080ssp585[[2*i]] = thresh4
  
  proj.areas[2*i, 8] = expanse(thresh1, unit = "km")$area
  proj.areas[40 + 2*i, 8] = expanse(thresh2, unit = "km")$area
  proj.areas[80 + 2*i, 8] = expanse(thresh3, unit = "km")$area
  proj.areas[120 + 2*i, 8] = expanse(thresh4, unit = "km")$area
}

for(i in 1:(nrow(intpair.df)/2)){
  # 2040, ssp245
  overlap1 = threshold.2040ssp245[[(2*i)-1]]
  idm1 = threshold.2040ssp245[[2*i]]
  idm1[idm1 == 1] = 10
  shared1 = overlap1 + idm1
  idm1 = shared1
  overlap1 = shared1
  idm1[idm1 != 10] = NA
  overlap1[overlap1 != 1] = NA
  
  proj.areas[(2*i)-1, 9] = expanse(overlap1, unit = "km")$area
  proj.areas[(2*i)-1, 10] = expanse(idm1, unit = "km")$area
  
  # 2080 ssp245
  overlap2 = threshold.2080ssp245[[(2*i)-1]]
  idm2 = threshold.2080ssp245[[2*i]]
  idm2[idm2 == 1] = 10
  shared2 = overlap2 + idm2
  idm2 = shared2
  overlap2 = shared2
  idm2[idm2!= 10] = NA
  overlap2[overlap2 != 1] = NA
  
  proj.areas[40+(2*i)-1, 9] = expanse(overlap2, unit = "km")$area
  proj.areas[40+(2*i)-1, 10] = expanse(idm2, unit = "km")$area
  
  
# 2040, ssp585
  overlap3 = threshold.2040ssp585[[(2*i)-1]]
  idm3 = threshold.2040ssp585[[2*i]]
  idm3[idm3 == 1] = 10
  shared3 = overlap3 + idm3
  idm3 = shared3
  overlap3 = shared3
  idm3[idm3!= 10] = NA
  overlap3[overlap3 != 1] = NA
  
  proj.areas[80+(2*i)-1, 9] = expanse(overlap3, unit = "km")$area
  proj.areas[80+(2*i)-1, 10] = expanse(idm3, unit = "km")$area
  
  # 2080, ssp585
  overlap4 = threshold.2080ssp585[[(2*i)-1]]
  idm4 = threshold.2080ssp585[[2*i]]
  idm4[idm4 == 1] = 10
  shared4 = overlap4 + idm4
  idm4 = shared4
  overlap4 = shared4
  idm4[idm4!= 10] = NA
  overlap4[overlap4 != 1] = NA
  
  proj.areas[120+(2*i)-1, 9] = expanse(overlap4, unit = "km")$area
  proj.areas[120+(2*i)-1, 10] = expanse(idm4, unit = "km")$area
}

proj.areas2 <- proj.areas %>%
  filter(model == "overlap") %>%
  mutate(overlap_area = round(overlap_area, digits = 0),
         idm_area = round(idm_area, digits = 0)) %>%
  dplyr::select(pair, plant, bombus, time, ssp, overlap_area, idm_area) %>%
  left_join(bbna.sum, by = c("bombus" = "species")) %>%
  left_join(gbif.sum, by = c("plant" = "genus")) %>%
  left_join(int.sum, by = c(c("bombus" = "species"), c("plant" = "plant.host.genus"), "n_bombus"))

overlaparea.mod <- glmmTMB(overlap_area ~ bombus + plant + relabund_int + (1|time) + (1|ssp), data = proj.areas2, family = poisson)
summary(overlaparea.mod)

idmarea.mod <- glmmTMB(idm_area ~ ssp + time + (1|bombus) + (1|plant), data = proj.areas, family = poisson)
summary(idmarea.mod)
```


# RMSE Figure
```{r rmse fig}
# Add initial RMSEs
initial.rmse <- all.evals %>%
  group_by(X) %>%
  summarise(RMSE = mean(RMSE, na.rm = T)) %>%
  rename(pair = X)

RMSE.df2 <- bind_rows(RMSE.df, initial.rmse) %>%
  left_join(bbna.sum, by = c("bombus" = "species")) %>%
  left_join(gbif.sum, by = c("plant" = "genus")) %>%
  left_join(int.sum, by = c(c("bombus" = "species"), c("plant" = "plant.host.genus"), "n_bombus")) %>%
  pivot_wider(names_from = year, values_from = RMSE) %>%
  rename(year_2040 = `2040`,
         year_2080 = `2080`,
         year_2020 = `NA`) %>%
  mutate(RMSE_diff_40 = year_2020 - year_2040,
         RMSE_diff_80 = year_2080 - year_2040)

RMSE.mod <- glmmTMB(RMSE_diff_80 ~ plant + bombus + relabund_int + (1|ssp), data = RMSE.df2, family = gaussian)
summary(RMSE.mod)
Anova(RMSE.mod)

rmse.fig <- ggplot(RMSE.df, aes(x = pair, y = RMSE, fill = as.factor(paste(year, ssp, sep = ".")))) +
  geom_bar(stat = "identity",
           position = "dodge") +
  labs(fill = "Projection") +
  coord_flip()


```

